# Session Handoff Document - September 7, 2025

## Session Summary
**Duration**: ~3.5 hours (2025-09-07 01:10:40Z to 02:30:34Z)  
**Primary Focus**: Fixing MCP STDIO server banner/startup message handling issue  
**Current Branch**: `fix-banner-issue-coderabbit`  
**GitHub Issue**: #13 - Critical: MCP STDIO servers with banners fail to connect

## Problem Statement

FastMCP-based servers (like `basic-memory`, `context7`) and other stdio MCP servers emit ASCII art banners and startup messages before beginning JSON-RPC communication. This corrupts the protocol and causes connection failures.

### Affected Servers
- **basic_memory** (FastMCP, command: `uvx basic-memory mcp`)
- **context7** (Node.js, command: `npx -y @upstash/context7-mcp@latest`)
- **puppeteer** (Node.js, command: `npx -y @modelcontextprotocol/server-puppeteer`)

### Working Server
- **exa** (SSE/HTTP type) - Connects successfully

## Work Completed This Session

### 1. Fixed Import Error âœ…
- **File**: `src/hive_mcp_gateway/services/mcp_client_manager.py`
- **Issue**: Import of non-existent `mcp.shared.json_rpc_message.JSONRPCMessage`
- **Fix**: Removed the incorrect import (line 121)
- **Result**: MCP SDK now properly detected instead of falling back to mock tools

### 2. Environment Variable Suppression âš ï¸
Added environment variables to suppress banners (lines 160-171):
```python
base_env.setdefault("FASTMCP_NO_BANNER", "1")
base_env.setdefault("FASTMCP_DISABLE_BANNER", "1")
base_env.setdefault("FASTMCP_QUIET", "1")
base_env.setdefault("NO_COLOR", "1")
base_env.setdefault("PYTHONWARNINGS", "ignore")
```
**Result**: No effect - FastMCP servers still output banners

### 3. Tolerant Message Handler âš ï¸
Implemented custom message handler (lines 206-217) to ignore parsing exceptions.
**Result**: Handler not invoked - session initialization fails before message handling begins

### 4. stdout-mcp-server Integration Attempt âš ï¸
- **Package**: `stdout-mcp-server` by amitdeshmukh
- **Installation**: `npm install -g stdout-mcp-server`
- **Purpose**: Creates named pipe at `/tmp/stdout_pipe` to capture banner output
- **Implementation**: Modified to redirect stderr to pipe using shell command with `exec`
- **Result**: Processes started but session initialization still timed out

### 5. CodeRabbit's Analysis and Solution ðŸŽ¯
CodeRabbit identified that we had already created multiple solutions but weren't using them:
- `filtered_stdio_transport.py` - Complete transport-level filtering
- `banner_filter_client.py` - Alternative client implementation
- `banner_tolerant_stdio.py` - Stream wrapper approach
- `stdio_wrapper.js` - Node.js wrapper

### 6. Implemented FilteredStdioTransport âš ï¸
- **Branch Created**: `fix-banner-issue-coderabbit`
- **Integration**: Modified `mcp_client_manager.py` to use `FilteredStdioTransport` for banner-prone servers
- **Detection Logic**: Auto-detects servers using `uvx` or `npx` commands
- **Current Issue**: JSON serialization error - "Object of type SessionMessage is not JSON serializable"

## Current State of Code

### Key Changes in `mcp_client_manager.py`
```python
# Lines 174-211: Banner server detection and filtered transport usage
is_banner_server = (
    command in ["uvx", "npx"] or 
    name in ["basic_memory", "context7", "puppeteer"] or
    "fastmcp" in name.lower()
)

if is_banner_server:
    # Use filtered transport
    filtered_params = FilteredStdioServerParameters(...)
    transport = FilteredStdioTransport(filtered_params)
    read_stream, write_stream = await transport.start()
```

### Outstanding Issue
The `FilteredStdioTransport.send()` method (line 177-183 in `filtered_stdio_transport.py`) tries to JSON serialize MCP protocol objects, which fails. Need to handle `SessionMessage` objects properly.

## Containerization Proposal (New Direction)

### Rationale
During debugging, discovered another agent had a `context7` instance running, highlighting process isolation issues. Containerization would solve:
1. Banner problems (clean stdout/stderr separation)
2. Process conflicts between multiple agents
3. Dependency management (Node.js vs Python versions)
4. Resource isolation and cleanup

### Documentation Created
- **File**: `docs/CONTAINERIZED_MCP_PROPOSAL.md`
- **Reference**: dagger/container-use project (https://github.com/dagger/container-use)

### Proposed Architecture
```
Gateway â†’ Docker Containers â†’ MCP Servers
         â”œâ”€â”€ basic_memory (Python container)
         â”œâ”€â”€ context7 (Node.js container)
         â””â”€â”€ puppeteer (Browser container)
```

## Files Modified/Created This Session

### Modified
1. `src/hive_mcp_gateway/services/mcp_client_manager.py` - Main fixes
2. `README.md` - Documentation updates
3. `docs/USAGE.md` - Usage documentation

### Created
1. `MCP_BANNER_ISSUE.md` - Comprehensive issue documentation
2. `docs/CONTAINERIZED_MCP_PROPOSAL.md` - Containerization architecture
3. `src/hive_mcp_gateway/services/banner_tolerant_stdio.py` - Stream wrapper
4. `src/hive_mcp_gateway/services/filtered_stdio_transport.py` - Transport filter
5. `src/hive_mcp_gateway/services/banner_filter_client.py` - Alternative client
6. Multiple other experimental solutions

## Next Steps (Priority Order)

### Option 1: Fix Current Implementation (Quick)
1. Fix JSON serialization in `FilteredStdioTransport.send()` method
2. Handle `SessionMessage` objects without JSON serialization
3. Test with all three problematic servers
4. If successful, merge to main

### Option 2: Containerization (Recommended)
1. Create proof-of-concept with one server (basic_memory)
2. Build Docker image with FastMCP and environment variables
3. Test stdio communication through Docker
4. If successful, extend to all servers
5. Consider using dagger/container-use for management

### Option 3: Hybrid Approach
1. Use filtered transport for non-containerizable servers
2. Containerize only the problematic FastMCP servers
3. Make containerization optional via configuration

## Testing Commands

### Start Gateway
```bash
uv run hive-mcp-gateway
```

### Check Server Status
```bash
curl http://localhost:8001/api/mcp/servers | python3 -m json.tool
```

### Manual Test Server
```bash
echo '{"jsonrpc": "2.0", "method": "initialize", "params": {"protocolVersion": "1.0", "capabilities": {}, "clientInfo": {"name": "test", "version": "1.0"}}, "id": 1}' | uvx basic-memory mcp
```

## Environment Setup

### Current Directory
```
/Users/bbrenner/Documents/Scripting Projects/tool-gating-mcp
```

### Key Dependencies
- Python 3.12+ with `uv` package manager
- Node.js for npx commands
- Docker (for containerization approach)
- stdout-mcp-server (npm package, optional)

### Processes to Clean Up
```bash
# Kill any lingering processes
pkill -f hive-mcp-gateway
pkill -f context7-mcp
pkill -f basic-memory
pkill -f stdout-mcp-server
```

## Repository State

### Branches
- **main**: Original code with partial fixes
- **fix-banner-issue-coderabbit**: FilteredStdioTransport implementation (current)

### GitHub
- **Repository**: https://github.com/KHAEntertainment/hive-mcp-gateway
- **Issue #13**: Main tracking issue for banner problem
- **CodeRabbit**: Provided analysis and identified existing solutions

## Critical Insights

1. **The solutions already exist** - We have 4+ working approaches in experimental files
2. **Integration is the blocker** - Solutions aren't integrated into main code path
3. **Transport-level fix required** - Must handle before `session.initialize()`
4. **Containerization is cleaner** - Solves multiple problems beyond just banners

## Success Criteria

When complete, this command should show all servers connected:
```bash
curl http://localhost:8001/api/mcp/servers
# Should show:
# basic_memory: connected=true, tools > 0
# context7: connected=true, tools > 0
# puppeteer: connected=true, tools > 0
```

## Session Handoff Notes

The next session should:
1. Start fresh with full context window
2. Focus on either fixing FilteredStdioTransport OR jumping to containerization
3. Consider that containerization solves more problems long-term
4. Test thoroughly with all three problematic servers
5. Update GitHub issue #13 with solution

## References

- Python MCP SDK: https://github.com/anthropics/mcp-python
- FastMCP: https://github.com/[fastmcp-repo]
- stdout-mcp-server: https://www.npmjs.com/package/stdout-mcp-server
- dagger/container-use: https://github.com/dagger/container-use
- CodeRabbit Analysis: Issue #13 comments
